# 分布式技术

## 1. 分布式理论与算法

### CAP理论

CAP，BASE和最终一致性是NoSQL数据库存在的三大基石。而五分钟法则是内存数据存储的理论依据。这个是一切的源头

- C 多副本之间能否保持一致的特性
- A 可用性 非故障节点在`合理的时间`内返回`合理的响应 `
- P 集群可用性 网络是无法保证100%可靠，分区是别然现象，P必须保证

ZooKeeper是典型的CP模型

Redis是AP模型遵循BASE理论，放弃的C是强一致性，百万并发下分布式锁失效的根本原因

### BASE理论

核心思想：分布式事务中只需要到最终一致性即可
- 基本可用(Basically Available) 服务器故障期间，集群整体仍可对外提供服务
- 软状态(Soft State) 软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据至少会有三个副本，允许不同节点间副本同步的延时就是软状态的体现。MySQL Replication 的异步复制也是一种体现
- 最终一致性(Eventual Consistency) 最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况

**ACID（刚性） 和 BASE（柔性） 的区别与联系：**

- ACID 是传统数据库常用的设计理念，追求强一致性模型。BASE 支持的是大型分布式系统，提出通过牺牲强一致性获得高可用性
- ACID 和 BASE 代表了两种截然相反的设计哲学，在分布式系统设计的场景中，系统组件对一致性要求是不同的，因此 ACID 和 BASE 又会结合使用

### 2PC、3PC、XA协议

DTP模型：X/Open DTP(X/Open Distributed Transaction Processing Reference Model) 是X/Open 这个组织定义的一套`分布式事务的标准`，也就是了定义了规范和API接口，由厂商进行具体的实现

模型元素：
- AP(Application Program)：也就是应用程序，可以理解为使用DTP的程序
- RM(Resource Manager)：资源管理器，如数据库，文件系统等，并提供资源访问的方式
- TM(Transaction Manager)：事务管理器
- CRM(Communication Resource Managers): 通讯资源管理器
- CP(Communication Protocol): 通信协议

XA规范的作用定义了RM和TM的接口交互规范，java的实现方式叫做`JTA(Java Transaction API)`

**两阶段提交**

两阶段提交又称2PC,2PC是一个非常经典的强一致、中心化的原子提交协议。

这里所说的中心化是指协议中有两类节点：一个是中心化协调者节点（coordinator）和N个参与者节点（partcipant）。

**第一阶段：投票阶段**
1. 事务询问
    - 协调者向所有的参与者发送事务预处理请求，称之为Prepare，并开始等待各参与者的响应。
2. 执行本地事务
    - 各个参与者节点执行本地事务操作,但在执行完成后并不会真正提交数据库本地事务，而是先向协调者报告说：“我这边可以处理了/我这边不能处理”。
3. 各参与者向协调者反馈事务询问的响应
    - 如果参与者成功执行了事务操作,那么就反馈给协调者Yes响应,表示事务可以执行,如果没有参与者成功执行事务,那么就反馈给协调者No响应,表示事务不可以执行。第一阶段执行完后，会有两种可能。1、所有都返回Yes. 2、有一个或者多个返回No。

**第二阶段：提交/执行阶段（成功流程）**
1. 所有的参与者反馈给协调者的信息都是Yes,那么就会执行事务提交
   - 协调者向所有参与者节点发出Commit请求.
2. 事务提交
   - 参与者收到Commit请求之后,就会正式执行本地事务Commit操作,并在完成提交之后释放整个事务执行期间占用的事务资源
  
**第二阶段：提交/执行阶段（异常流程）**
1. 发送回滚请求
  - 协调者向所有参与者节点发出RoollBack请求.
2. 事务回滚
  - 参与者接收到RoollBack请求后,会回滚本地事务。

**2PC缺点**
1. 性能问题 
   - 无论是在第一阶段的过程中,还是在第二阶段,所有的参与者资源和协调者资源都是被锁住的,只有当所有节点准备完毕，事务 协调者 才会通知进行全局提交，参与者进行本地事务提交后才会释放资源。这样的过程会比较漫长，对性能影响比较大
2. 单节点故障
   - 由于协调者的重要性，一旦协调者发生故障。参与者会一直阻塞下去。尤其在第二阶段，协调者发生故障，那么所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作。（虽然协调者挂掉，可以重新选举一个协调者，但是无法解决因为协调者宕机导致的参与者处于阻塞状态的问题）

**2PC出现单点问题的三种情况**
1. 协调者正常,参与者宕机
   - 由于协调者无法收集到所有参与者的反馈，会陷入阻塞情况。
   - 解决方案:引入超时机制,如果协调者在超过指定的时间还没有收到参与者的反馈,事务就失败,向所有节点发送终止事务请求
1. 协调者宕机,参与者正常
   - 无论处于哪个阶段，由于协调者宕机，无法发送提交请求，所有处于执行了操作但是未提交状态的参与者都会陷入阻塞情况.
   - 解决方案:引入协调者备份,同时协调者需记录操作日志.当检测到协调者宕机一段时间后，协调者备份取代协调者，并读取操作日志，向所有参与者询问状态
2. 协调者和参与者都宕机
   - 无法解决

**三阶段提交**

三阶段提交协议（3PC）主要是为了解决两阶段提交协议的阻塞问题，2pc存在的问题是当协作者崩溃时，参与者不能做出最后的选择。因此参与者可能在协作者恢复之前保持阻塞。三阶段提交（Three-phase commit），是二阶段提交（2PC）的改进版本

与两阶段提交不同的是，三阶段提交有两个改动点
1. 引入超时机制。同时在协调者和参与者中都引入超时机制
2. 在第一阶段和第二阶段中插入一个准备阶段。保证了在最后提交阶段之前各参与节点的状态是一致的
   
除了引入超时机制之外，3PC把2PC的准备阶段再次一分为二，这样三阶段提交就有CanCommit、PreCommit、DoCommit三个阶段
1. CanCommit阶段
   - 同2PC事务询问，相应反馈
3. PreCommit阶段
   - 在阶段一中，如果所有的参与者都返回Yes的话，那么就会进入PreCommit阶段进行事务预提交。这里的PreCommit阶段 跟上面的第一阶段是差不多的，只不过这里 协调者和参与者都引入了超时机制 （2PC中只有协调者可以超时，参与者没有超时机制）
4. DoCommit阶段
   - 同2PC

### POXOS算法、Raft算法、Zab协议

**Zab协议**
1. ZAB 协议全称：Zookeeper Atomic Broadcast（Zookeeper 原子广播协议）
2. Zookeeper 是一个为分布式应用提供高效且可靠的分布式协调服务。在解决分布式一致性方面，Zookeeper 并没有使用 Paxos ，而是采用了 ZAB 协议
3. ZAB 协议定义：ZAB 协议是为分布式协调服务Zookeeper专门设计的一种支持`崩溃恢复`和`原子广播`协议
4. 基于该协议，Zookeeper实现了一种`主备模式`的系统架构来保持集群中各个副本之间数据一致性
5. 复制过程类似2PC

整个Zookeeper就是在这两个模式之间切换。 简而言之，当Leader服务可以正常使用，就进入消息广播模式，当Leader不可用时,则进入崩溃恢复模式


### 分布式事务解决方案
1. 2PC
  - XA方案
  - Seata方案（AT、TCC）
2. TCC
  - Hmily方案 
3. 本地消息表（ebay）
4. 可靠消息最终一致性
  - 非事务型事务 activemq、rabbitmq、kafka
  - 事务型消息 rocketmq
5. 最大努力通知

`atomikos` 使用场景，单应用多数据源
`lcn`


## 2. Zookeeper源码解析

## 3. Dubbo源码解析

## 4. 消息队列

### RocketMq

Zookeeper集群分布式、主从,支持顺序，延时，事务消息，支持查询重试

### Kafka

Name Server分布式、主从

### RabbitMq

Erlang集群主从

## 5. 分布式锁

## 6. 分布式事务Seata

## 7. Elasticsearch 

## 8. 分布式全局ID

## 9. 分布式定时任务

### XXL

### ElasticJob

## 10. 分布式文件系统FastDFS

### FastDFS

### MinIO

### OOS

### Hadoop
